<!DOCTYPE html>
<html lang="pt-BR" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ResiFlow</title>
    
    <!-- PWA & iOS Configurações Otimizadas -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="ResiFlow">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f8fafc">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#09090b">
    
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon.svg">
    
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 950: '#020617' },
                        zinc: { 850: '#27272a', 900: '#18181b', 950: '#09090b' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-in-right': 'slideInRight 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideInRight: { '0%': { transform: 'translateX(20px)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase Module: Dispatches event when ready to fix race condition in Safari -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        
        window.firebaseModules = { initializeApp, getFirestore, doc, onSnapshot, setDoc, collection, getAuth, signInAnonymously };
        // Dispatch event for Safari/Async loading
        window.dispatchEvent(new Event('firebase-ready'));
    </script>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Wrap in try-catch for strict contexts
                try {
                    navigator.serviceWorker.register('./sw.js')
                        .then(reg => console.log('SW registrado'))
                        .catch(err => console.log('Falha SW (ignorado em dev)', err));
                } catch(e) { console.log('SW n/a'); }
            });
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --bg-color: #f8fafc;
            --text-color: #0f172a;
        }
        
        html.dark {
            --bg-color: #09090b;
            --text-color: #e2e8f0;
        }

        html { 
            background-color: var(--bg-color);
            transition: background-color 300ms ease;
            height: 100%;
            /* Fix for Safari Mobile Viewport */
            min-height: 100vh; 
            min-height: -webkit-fill-available;
            -webkit-text-size-adjust: 100%;
        }

        @media (prefers-color-scheme: dark) {
            html:not(.light) {
                background-color: #09090b;
                color: #e2e8f0;
            }
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            min-height: 100vh;
            min-height: -webkit-fill-available;
            width: 100%;
            overscroll-behavior-y: none; /* Prevents bounce effect */
            background-color: transparent;
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        input, select, textarea { font-size: 16px !important; /* Prevents zoom on iOS */ }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 99px; }
        .dark ::-webkit-scrollbar-thumb { background: #3f3f46; }
        
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
        .dark .glass { background: rgba(9, 9, 11, 0.85); border-bottom: 1px solid rgba(255,255,255,0.05); }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .mb-safe { margin-bottom: env(safe-area-inset-bottom); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none;  scrollbar-width: none; }

        #app-loader {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f8fafc;
            z-index: 9999;
            transition: opacity 0.3s ease-out;
        }
        @media (prefers-color-scheme: dark) {
            #app-loader { background-color: #09090b; }
        }
        html.dark #app-loader { background-color: #09090b; }
        
        .loader-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #3b82f6, #4f46e5);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.5);
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: .8; transform: scale(0.95); }
        }
    </style>
</head>
<body class="selection:bg-blue-500 selection:text-white">
    <div id="root" class="h-full">
        <div id="app-loader">
            <div class="loader-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
            </div>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- SAFE STORAGE WRAPPER (Prevents Safari Private Mode Crash) ---
        const safeStorage = {
            getItem: (key) => {
                try {
                    return localStorage.getItem(key);
                } catch (e) {
                    console.warn('LocalStorage access denied (Private Mode?)', e);
                    return null;
                }
            },
            setItem: (key, value) => {
                try {
                    localStorage.setItem(key, value);
                } catch (e) {
                    console.warn('LocalStorage write denied (Private Mode?)', e);
                }
            },
            getJSON: (key, fallback) => {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : fallback;
                } catch (e) {
                    return fallback;
                }
            }
        };

        const LucideIcon = ({ name, size = 24, className = "" }) => {
            const iconData = window.lucide && window.lucide.icons ? window.lucide.icons[name] : null;
            if (!iconData) return <span style={{width: size, height: size, display: 'inline-block'}} />;
            return React.createElement('svg', { xmlns: "http://www.w3.org/2000/svg", width: size, height: size, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: "2", strokeLinecap: "round", strokeLinejoin: "round", className: className }, iconData.map((ele, i) => React.createElement(ele[0], { ...ele[1], key: i })));
        };

        const Icons = {
            Target: (p) => <LucideIcon name="Target" {...p} />,
            Calendar: (p) => <LucideIcon name="Calendar" {...p} />,
            Plus: (p) => <LucideIcon name="Plus" {...p} />,
            CheckCircle2: (p) => <LucideIcon name="CheckCircle2" {...p} />,
            Clock: (p) => <LucideIcon name="Clock" {...p} />,
            BookOpen: (p) => <LucideIcon name="BookOpen" {...p} />,
            Star: (p) => <LucideIcon name="Star" {...p} />,
            X: (p) => <LucideIcon name="X" {...p} />,
            ChevronDown: (p) => <LucideIcon name="ChevronDown" {...p} />,
            ChevronUp: (p) => <LucideIcon name="ChevronUp" {...p} />,
            ChevronLeft: (p) => <LucideIcon name="ChevronLeft" {...p} />,
            ChevronRight: (p) => <LucideIcon name="ChevronRight" {...p} />,
            Activity: (p) => <LucideIcon name="Activity" {...p} />,
            Moon: (p) => <LucideIcon name="Moon" {...p} />,
            Sun: (p) => <LucideIcon name="Sun" {...p} />,
            List: (p) => <LucideIcon name="List" {...p} />,
            Trash2: (p) => <LucideIcon name="Trash2" {...p} />,
            Cloud: (p) => <LucideIcon name="Cloud" {...p} />,
            Save: (p) => <LucideIcon name="Save" {...p} />,
            Download: (p) => <LucideIcon name="Download" {...p} />,
            Upload: (p) => <LucideIcon name="Upload" {...p} />,
            Settings: (p) => <LucideIcon name="Settings" {...p} />,
            Timer: (p) => <LucideIcon name="Timer" {...p} />,
            Play: (p) => <LucideIcon name="Play" {...p} />,
            Pause: (p) => <LucideIcon name="Pause" {...p} />,
            RotateCcw: (p) => <LucideIcon name="RotateCcw" {...p} />,
            Layers: (p) => <LucideIcon name="Layers" {...p} />,
            Notebook: (p) => <LucideIcon name="Notebook" {...p} />,
            Search: (p) => <LucideIcon name="Search" {...p} />,
            BarChart3: (p) => <LucideIcon name="BarChart3" {...p} />,
            LinkIcon: (p) => <LucideIcon name="Link" {...p} />,
            FileJson: (p) => <LucideIcon name="FileJson" {...p} />,
            Lock: (p) => <LucideIcon name="Lock" {...p} />,
            Home: (p) => <LucideIcon name="Home" {...p} />,
            PieChart: (p) => <LucideIcon name="PieChart" {...p} />,
            MoreHorizontal: (p) => <LucideIcon name="MoreHorizontal" {...p} />,
            PenTool: (p) => <LucideIcon name="PenTool" {...p} />,
            MonitorPlay: (p) => <LucideIcon name="MonitorPlay" {...p} />,
            AlertTriangle: (p) => <LucideIcon name="AlertTriangle" {...p} />,
            ArrowLeft: (p) => <LucideIcon name="ArrowLeft" {...p} />,
            Bell: (p) => <LucideIcon name="Bell" {...p} />,
            Flame: (p) => <LucideIcon name="Flame" {...p} />,
            ListTodo: (p) => <LucideIcon name="ListTodo" {...p} />,
        };
        
        // --- UTILS & CONSTANTS ---
        const VIBRATE_PATTERNS = {
            tick: 10,
            success: [20, 30, 20],
            reviewDone: [50, 50, 50],
            streak: [100, 50, 100, 50, 100],
            error: [200]
        };

        const vibrate = (pattern = 10) => {
            if (typeof navigator !== 'undefined' && navigator.vibrate) navigator.vibrate(pattern);
        };

        const getTodayStr = () => {
            const d = new Date();
            return new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        };

        const formatDate = (d) => { if(!d) return ''; const [y, m, day] = d.split('-'); return `${day}/${m}`; };
        // Fixed Safari Date Parsing Issue
        const formatFullDate = (d) => { 
            if (!d) return ''; 
            // Ensure strictly valid ISO format for Safari
            const dateObj = new Date(`${d}T12:00:00`); 
            return dateObj.toLocaleDateString('pt-BR', { weekday: 'short', day: 'numeric', month: 'long' }); 
        };
        
        // Fixed Crypto UUID for older Safari
        const generateId = () => {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                try { return crypto.randomUUID(); } catch(e) {}
            }
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        };

        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCvqp5HYUMnogWmwT0O1LFLOMsfqj9P83s",
            authDomain: "med-heklp.firebaseapp.com",
            projectId: "med-heklp",
            storageBucket: "med-heklp.firebasestorage.app",
            messagingSenderId: "675054342845",
            appId: "1:675054342845:web:91e53e21060a087123ddd4",
            measurementId: "G-BLWYTWFFTZ"
        };

        const AREAS = [
            { id: 'clinica', name: 'Clínica', full: 'Clínica Médica', color: 'bg-blue-100 text-blue-700 dark:bg-blue-500/20 dark:text-blue-300 border-blue-200 dark:border-blue-500/30', accent: 'border-blue-500 shadow-blue-500/10' },
            { id: 'cirurgia', name: 'Cirurgia', full: 'Cirurgia Geral', color: 'bg-red-100 text-red-700 dark:bg-red-500/20 dark:text-red-300 border-red-200 dark:border-red-500/30', accent: 'border-red-500 shadow-red-500/10' },
            { id: 'pediatria', name: 'Pediatria', full: 'Pediatria', color: 'bg-amber-100 text-amber-700 dark:bg-amber-500/20 dark:text-amber-300 border-amber-200 dark:border-amber-500/30', accent: 'border-amber-500 shadow-amber-500/10' },
            { id: 'go', name: 'G.O.', full: 'Ginecologia', color: 'bg-purple-100 text-purple-700 dark:bg-purple-500/20 dark:text-purple-300 border-purple-200 dark:border-purple-500/30', accent: 'border-purple-500 shadow-purple-500/10' },
            { id: 'preventiva', name: 'Prev.', full: 'Preventiva', color: 'bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-300 border-emerald-200 dark:border-emerald-500/30', accent: 'border-emerald-500 shadow-emerald-500/10' },
        ];
        
        const SUB_AREAS = {
            'clinica': ['Cardiologia', 'Nefrologia', 'Pneumologia', 'Gastroenterologia', 'Hepatologia', 'Infectologia', 'Reumatologia', 'Hematologia', 'Endocrinologia', 'Neurologia', 'Psiquiatria', 'Dermatologia'],
            'cirurgia': ['Cirurgia Geral', 'Trauma', 'Cirurgia Digestiva', 'Cirurgia Vascular', 'Urologia', 'Ortopedia', 'Otorrinolaringologia', 'Oftalmologia'],
            'pediatria': ['Puericultura', 'Neonatologia', 'Infecto Ped', 'Respiratório', 'Gastro Ped', 'Nefro Ped', 'Emergências'],
            'go': ['Obstetrícia', 'Ginecologia Geral', 'Endocrino Ginecológica', 'Oncologia Ginecológica', 'Mastologia'],
            'preventiva': ['SUS', 'Epidemiologia', 'Saúde do Trabalhador', 'Ética Médica']
        };

        const IMPORTANCE_LEVELS = [
            { id: 'high', label: 'Alta', weight: 1.5, color: 'text-red-600 dark:text-red-400', bg: 'bg-red-50 dark:bg-red-900/20', baseQ: 30 },
            { id: 'medium', label: 'Média', weight: 1.25, color: 'text-amber-600 dark:text-amber-400', bg: 'bg-amber-50 dark:bg-amber-900/20', baseQ: 25 },
            { id: 'low', label: 'Baixa', weight: 1.0, color: 'text-slate-500 dark:text-slate-400', bg: 'bg-slate-100 dark:bg-slate-800', baseQ: 20 },
        ];

        const LOG_TYPES = [
            { id: 'questions', label: 'Questões', icon: Icons.Target, color: 'text-blue-500' },
            { id: 'anki', label: 'Anki', icon: Icons.Layers, color: 'text-purple-500' },
            { id: 'class', label: 'Aula', icon: Icons.MonitorPlay, color: 'text-red-500' },
            { id: 'reading', label: 'Leitura', icon: Icons.BookOpen, color: 'text-emerald-500' },
            { id: 'other', label: 'Outro', icon: Icons.PenTool, color: 'text-slate-500' },
        ];

        const SYSTEM_PARAMS = { BASE_QUESTIONS: 20, MIN_QUESTIONS: 15, MAX_QUESTIONS: 100, TARGET_ACCURACY: 0.90, SPACING_FACTORS: { 'R0': 1.0, 'R1': 2.5, 'R2': 1.25, 'R3': 1.0, 'DEFAULT': 1.0 }, PERF_CAP: 2.2 };

        const calculateNextLoad = (importanceId, diffId, stage, acc) => {
            const impObj = IMPORTANCE_LEVELS.find(i => i.id === importanceId) || IMPORTANCE_LEVELS[1];
            const base = impObj.baseQ;
            const stageFactor = SYSTEM_PARAMS.SPACING_FACTORS[stage] || 1.0;
            const diffWeight = diffId === 'easy' ? 0.9 : diffId === 'hard' ? 1.1 : 1.0;
            let perfFactor = 1.0;
            if (acc !== null) {
                if (acc >= 1.0) perfFactor = 0.9;
                else if (acc < 0.85) { const gap = Math.max(0, 0.90 - acc); perfFactor = Math.min(2.2, 1 + (gap * 2.0)); }
            }
            let n = Math.round(base * stageFactor * diffWeight * perfFactor);
            if (acc !== null && acc < 0.60) n += 10;
            return Math.max(15, Math.min(n, 100));
        };

        const generateSchedule = (date, importanceId) => {
            const d0 = new Date(date + 'T12:00:00');
            const add = (d, days) => { const r = new Date(d); r.setDate(r.getDate() + days); return r.toISOString().split('T')[0]; };
            const impObj = IMPORTANCE_LEVELS.find(i => i.id === importanceId) || IMPORTANCE_LEVELS[1];
            const q1 = calculateNextLoad(importanceId, 'medium', 'R1', null);
            const q2 = calculateNextLoad(importanceId, 'medium', 'R2', null);
            const q3 = calculateNextLoad(importanceId, 'medium', 'R3', null);
            return [
                { type: 'R0', date: date, label: 'R0: Fixação', done: false, correct: 0, total: 0, difficulty: null, targetQ: impObj.baseQ },
                { type: 'R1', date: add(d0, 7), label: 'R1: Pico', done: false, correct: 0, total: 0, difficulty: null, targetQ: q1 },
                { type: 'R2', date: add(d0, 30), label: 'R2: Manutenção', done: false, correct: 0, total: 0, difficulty: null, targetQ: q2 },
                { type: 'R3', date: add(d0, 60), label: 'R3: Longo', done: false, correct: 0, total: 0, difficulty: null, targetQ: q3 }
            ];
        };

        const mergeItems = (local, cloud) => {
            const map = new Map();
            local.forEach(i => map.set(i.id, i));
            cloud.forEach(c => {
                const l = map.get(c.id);
                if (!l || (c.updatedAt || 0) > (l.updatedAt || 0)) map.set(c.id, c);
            });
            return Array.from(map.values());
        };

        const useSync = (topics, logs, setTopics, setLogs) => {
            const [status, setStatus] = useState('offline');
            const [config, setConfig] = useState(() => safeStorage.getJSON('resiflow_fb_config', USER_FIREBASE_CONFIG));
            const [syncKey, _setSyncKey] = useState(() => safeStorage.getItem('resiflow_sync_key') || '');
            const [firebaseReady, setFirebaseReady] = useState(!!window.firebaseModules);
            
            // Safari Fix: Listen for module loading event
            useEffect(() => {
                if (window.firebaseModules) setFirebaseReady(true);
                const onReady = () => setFirebaseReady(true);
                window.addEventListener('firebase-ready', onReady);
                return () => window.removeEventListener('firebase-ready', onReady);
            }, []);
            
            const setSyncKey = (newKey) => {
                if (newKey !== syncKey) { setTopics([]); setLogs([]); }
                _setSyncKey(newKey);
                safeStorage.setItem('resiflow_sync_key', newKey);
            };

            const dbRef = useRef(null);
            const stateRef = useRef({ topics, logs });
            useEffect(() => { stateRef.current = { topics, logs }; }, [topics, logs]);

            useEffect(() => {
                if (!firebaseReady || !config || !syncKey || !window.firebaseModules) return;
                try {
                    const { initializeApp, getFirestore, doc, onSnapshot, getAuth, signInAnonymously } = window.firebaseModules;
                    let app;
                    try { app = initializeApp(config); } catch(e) { app = window.firebaseModules.app; }
                    
                    const auth = getAuth();
                    signInAnonymously(auth).then(() => {
                        const db = getFirestore();
                        dbRef.current = db;
                        const docRef = doc(db, 'artifacts', 'resiflow', 'public', 'data', 'users', syncKey);
                        setStatus('syncing');
                        const unsub = onSnapshot(docRef, (s) => {
                            if (s.exists()) { 
                                const d = s.data(); 
                                if (d.topics) {
                                    const mergedTopics = mergeItems(stateRef.current.topics, d.topics);
                                    if (JSON.stringify(mergedTopics) !== JSON.stringify(stateRef.current.topics)) setTopics(mergedTopics);
                                }
                                if (d.logs) {
                                    const mergedLogs = mergeItems(stateRef.current.logs, d.logs);
                                    if (JSON.stringify(mergedLogs) !== JSON.stringify(stateRef.current.logs)) setLogs(mergedLogs);
                                }
                            }
                            setStatus('online');
                        }, (err) => { console.error(err); setStatus('error'); });
                        return () => unsub();
                    }).catch((e) => { console.error("Auth failed", e); setStatus('error'); });

                } catch (e) { console.error(e); setStatus('error'); }
            }, [config, syncKey, firebaseReady]);

            const saveToCloud = async (newTopics, newLogs) => {
                if (!dbRef.current || !syncKey || !window.firebaseModules) return;
                try {
                    const { doc, setDoc } = window.firebaseModules;
                    const docRef = doc(dbRef.current, 'artifacts', 'resiflow', 'public', 'data', 'users', syncKey);
                    await setDoc(docRef, { topics: newTopics, logs: newLogs, updatedAt: new Date().toISOString() }, { merge: true });
                } catch (e) { console.error(e); setStatus('error'); }
            };
            return { status, config, setConfig, syncKey, setSyncKey, saveToCloud };
        };

        const ModalWrapper = ({ isOpen, onClose, children, title }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-end md:items-center justify-center sm:p-4 pb-safe">
                    <div className="absolute inset-0 bg-black/60 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative w-full max-w-lg bg-white dark:bg-zinc-900 md:rounded-2xl rounded-t-2xl shadow-2xl animate-slide-up flex flex-col max-h-[90vh] mb-safe md:mb-0">
                        <div className="p-4 border-b border-slate-100 dark:border-zinc-800 flex justify-between items-center bg-white/50 dark:bg-zinc-900/50 backdrop-blur-md rounded-t-2xl z-10">
                            <h3 className="text-lg font-bold text-slate-800 dark:text-white">{title}</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 dark:hover:bg-zinc-800 rounded-full"><Icons.X size={20} className="text-slate-400"/></button>
                        </div>
                        <div className="overflow-y-auto p-0">{children}</div>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, topics, logs, setTopics, setLogs, syncKey, setSyncKey, status }) => {
            const [tempKey, setTempKey] = useState(syncKey);
            useEffect(() => setTempKey(syncKey), [syncKey]);
            
            const requestNotificationPermission = async () => {
                if (!("Notification" in window)) {
                    alert("Este navegador não suporta notificações.");
                    return;
                }
                const permission = await Notification.requestPermission();
                if (permission === "granted") {
                    new Notification("Notificações Ativadas", { body: "Você receberá lembretes das suas revisões!", icon: "icon.svg" });
                } else {
                    alert("Permissão negada. Verifique as configurações do navegador.");
                }
            };

            const handleExport = () => {
                const dataStr = JSON.stringify({ topics, logs }, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `resiflow_bkp_${getTodayStr()}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            };
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (!Array.isArray(data.topics) && !Array.isArray(data.logs)) { throw new Error("Formato inválido"); }
                        if (data.topics && Array.isArray(data.topics)) setTopics(prev => mergeItems(Array.isArray(prev) ? prev : [], data.topics));
                        if (data.logs && Array.isArray(data.logs)) setLogs(prev => mergeItems(Array.isArray(prev) ? prev : [], data.logs));
                        alert('Backup importado com sucesso!'); onClose();
                    } catch (err) { console.error(err); alert('Erro ao importar: Arquivo inválido ou corrompido.'); }
                };
                reader.readAsText(file);
                e.target.value = null;
            };
            return (
                <ModalWrapper isOpen={isOpen} onClose={onClose} title="Configurações">
                    <div className="p-6 space-y-6">
                         <div className="p-4 rounded-xl bg-blue-50 dark:bg-blue-900/10 border border-blue-100 dark:border-blue-900/50">
                            <h4 className="font-bold text-sm text-blue-700 dark:text-blue-300 mb-3 flex items-center gap-2"><Icons.Cloud size={16}/> Sincronização Nuvem</h4>
                            <div className="space-y-3">
                                <div><label className="text-[10px] font-bold text-slate-500 dark:text-slate-400 uppercase block mb-1">Chave de Acesso</label><div className="flex gap-2"><input type="text" value={tempKey} onChange={e => setTempKey(e.target.value)} placeholder="Crie uma senha única" className="flex-1 p-2 rounded-lg bg-white dark:bg-zinc-950 border border-slate-200 dark:border-zinc-700 text-sm dark:text-white font-mono" /><button onClick={() => { setSyncKey(tempKey); onClose(); }} className="bg-blue-600 hover:bg-blue-700 text-white px-3 rounded-lg font-bold text-xs">Salvar</button></div></div>
                                <div className="flex items-center gap-2 text-xs"><div className={`w-2 h-2 rounded-full ${status === 'online' ? 'bg-emerald-500' : 'bg-slate-400'}`}></div><span className="text-slate-500 dark:text-slate-400">{status === 'online' ? 'Conectado e Sincronizando' : 'Desconectado'}</span></div>
                            </div>
                        </div>
                        
                        <div className="p-4 rounded-xl bg-slate-50 dark:bg-zinc-800 border border-slate-100 dark:border-zinc-700">
                            <button onClick={requestNotificationPermission} className="w-full flex items-center justify-between text-sm font-bold text-slate-700 dark:text-slate-200">
                                <span className="flex items-center gap-2"><Icons.Bell size={16}/> Ativar Notificações</span>
                                <span className="text-blue-500 text-xs">Configurar</span>
                            </button>
                        </div>

                        <div className="p-4 rounded-xl bg-slate-50 dark:bg-zinc-800 border border-slate-100 dark:border-zinc-700">
                            <h4 className="font-bold text-sm text-slate-700 dark:text-slate-200 mb-2 flex items-center gap-2"><Icons.FileJson size={16}/> Backup Local</h4>
                            <div className="flex gap-2"><button onClick={handleExport} className="flex-1 bg-white dark:bg-zinc-700 hover:bg-slate-100 text-slate-700 dark:text-white py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 border border-slate-200 dark:border-zinc-600"><Icons.Download size={14}/> Exportar</button><label className="flex-1 bg-slate-800 hover:bg-slate-900 text-white py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 cursor-pointer"><Icons.Upload size={14}/> Importar <input type="file" accept=".json" className="hidden" onChange={handleImport}/></label></div>
                        </div>
                    </div>
                </ModalWrapper>
            );
        };

        const PomodoroTimer = ({ isOpen, onClose }) => {
            if(!isOpen) return null;
            const [timeLeft, setTimeLeft] = useState(25 * 60);
            const [isActive, setIsActive] = useState(false);
            const [mode, setMode] = useState('focus');
            useEffect(() => {
                let interval = null;
                if (isActive && timeLeft > 0) interval = setInterval(() => setTimeLeft(t => t - 1), 1000);
                else if (timeLeft === 0) setIsActive(false);
                return () => clearInterval(interval);
            }, [isActive, timeLeft]);
            const modes = { focus: 25*60, short: 5*60, long: 15*60 };
            const changeMode = (m) => { setMode(m); setIsActive(false); setTimeLeft(modes[m]); };
            const fmt = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
            const progress = ((modes[mode] - timeLeft) / modes[mode]) * 100;
            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/70 backdrop-blur-md">
                     <div className="relative w-full max-w-sm bg-white dark:bg-zinc-900 rounded-3xl p-8 shadow-2xl flex flex-col items-center">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icons.X size={24}/></button>
                        <h3 className="font-bold text-slate-800 dark:text-white mb-6 flex items-center gap-2 text-lg"><Icons.Timer className="text-emerald-500"/> Foco & Fluxo</h3>
                        <div className="flex gap-2 mb-8 bg-slate-100 dark:bg-zinc-950 p-1.5 rounded-xl">{Object.keys(modes).map(m => (<button key={m} onClick={() => { vibrate(VIBRATE_PATTERNS.tick); changeMode(m); }} className={`px-4 py-1.5 text-xs font-bold rounded-lg capitalize transition-all ${mode === m ? 'bg-white dark:bg-zinc-800 text-emerald-600 dark:text-emerald-400 shadow-sm' : 'text-slate-400'}`}>{m === 'focus' ? 'Foco' : m === 'short' ? 'Pausa Curta' : 'Pausa Longa'}</button>))}</div>
                        <div className="relative w-56 h-56 flex items-center justify-center mb-8"><svg className="absolute top-0 left-0 w-full h-full transform -rotate-90"><circle cx="112" cy="112" r="100" stroke="currentColor" strokeWidth="8" fill="transparent" className="text-slate-100 dark:text-zinc-800"/><circle cx="112" cy="112" r="100" stroke="currentColor" strokeWidth="8" fill="transparent" strokeDasharray={628} strokeDashoffset={628 - (628 * progress) / 100} className="text-emerald-500 transition-all duration-1000 ease-linear" strokeLinecap="round"/></svg><div className="text-6xl font-black text-slate-800 dark:text-white tracking-widest font-mono">{fmt(timeLeft)}</div></div>
                        <div className="flex gap-4"><button onClick={() => { vibrate(VIBRATE_PATTERNS.tick); setIsActive(!isActive); }} className={`w-16 h-16 rounded-2xl flex items-center justify-center text-2xl shadow-lg transition-transform active:scale-95 ${isActive ? 'bg-slate-100 dark:bg-zinc-800 text-slate-600 dark:text-slate-300' : 'bg-emerald-500 text-white shadow-emerald-500/30'}`}>{isActive ? <Icons.Pause fill="currentColor"/> : <Icons.Play fill="currentColor" className="ml-1"/>}</button><button onClick={() => { vibrate(VIBRATE_PATTERNS.tick); changeMode(mode); }} className="w-16 h-16 rounded-2xl flex items-center justify-center bg-slate-100 dark:bg-zinc-800 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors"><Icons.RotateCcw/></button></div>
                     </div>
                </div>
            );
        };

        const DiaryView = ({ logs, onAddLog, onDeleteLog, topics }) => {
            const [selectedDate, setSelectedDate] = useState(getTodayStr());
            const [showUpcoming, setShowUpcoming] = useState(false);
            
            const scrollRef = useRef(null);

            useEffect(() => {
                if(scrollRef.current) {
                    scrollRef.current.scrollLeft = scrollRef.current.scrollWidth;
                }
            }, []); 

            const changeDate = (days) => {
                const d = new Date(selectedDate + 'T12:00:00');
                d.setDate(d.getDate() + days);
                setSelectedDate(d.toISOString().split('T')[0]);
            };

            const getStatus = (date) => {
                const dayLogs = logs.filter(l => l.date === date && !l.deleted && l.type === 'checklist');
                return {
                    questions: dayLogs.some(l => l.desc === 'Questões'),
                    anki: dayLogs.some(l => l.desc === 'Anki'),
                    class: dayLogs.some(l => l.desc === 'Aula')
                };
            };

            const toggleChecklist = (item) => {
                vibrate(VIBRATE_PATTERNS.tick);
                const status = getStatus(selectedDate);
                const isDone = status[item === 'Questões' ? 'questions' : item === 'Anki' ? 'anki' : 'class'];
                
                if (isDone) {
                    const logToRemove = logs.find(l => l.date === selectedDate && !l.deleted && l.type === 'checklist' && l.desc === item);
                    if (logToRemove) onDeleteLog(logToRemove.id);
                } else {
                    onAddLog({
                        id: generateId(),
                        date: selectedDate,
                        type: 'checklist',
                        desc: item,
                        val: '1',
                        updatedAt: Date.now(),
                        deleted: false
                    });
                    vibrate(VIBRATE_PATTERNS.success);
                }
            };

            const status = getStatus(selectedDate);
            
            const heatmapData = useMemo(() => {
                const today = new Date();
                const data = [];
                for (let i = 120; i >= 0; i--) {
                    const d = new Date(today);
                    d.setDate(d.getDate() - i);
                    const dateStr = d.toISOString().split('T')[0];
                    const dayLogs = logs.filter(l => l.date === dateStr && !l.deleted && l.type === 'checklist');
                    const count = dayLogs.length;
                    data.push({ date: dateStr, count });
                }
                return data;
            }, [logs]);

            const streak = useMemo(() => {
                let currentStreak = 0;
                const today = new Date();
                let d = new Date(today);
                
                const todayStr = d.toISOString().split('T')[0];
                const todayActive = logs.some(l => l.date === todayStr && !l.deleted && l.type === 'checklist');
                if (!todayActive) {
                    d.setDate(d.getDate() - 1); 
                }

                while (true) {
                    const dateStr = d.toISOString().split('T')[0];
                    const active = logs.some(l => l.date === dateStr && !l.deleted && l.type === 'checklist');
                    if (active) {
                        currentStreak++;
                        d.setDate(d.getDate() - 1);
                    } else {
                        break;
                    }
                }
                return currentStreak;
            }, [logs]);

            const upcomingReviews = useMemo(() => {
                const upcoming = [];
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = tomorrow.toISOString().split('T')[0];

                topics.forEach(t => {
                    if (t.deleted) return;
                    t.reviews.forEach(r => {
                        if (!r.done && r.date >= tomorrowStr) {
                            upcoming.push({ topic: t, review: r });
                        }
                    });
                });
                return upcoming.sort((a, b) => a.review.date.localeCompare(b.review.date)).slice(0, 10);
            }, [topics]);

            return (
                <div className="animate-fade-in pb-32 space-y-6">
                    <div className="flex justify-between items-end px-2">
                        <div>
                            <h2 className="text-xl font-bold text-slate-800 dark:text-white">Hábito & Constância</h2>
                            <p className="text-xs font-medium text-slate-500 dark:text-slate-400">Construa sua disciplina dia após dia.</p>
                        </div>
                        <div className="flex items-center gap-1.5 bg-orange-50 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400 px-3 py-1.5 rounded-xl border border-orange-100 dark:border-orange-900/30">
                            <Icons.Flame size={18} className="fill-current" />
                            <span className="font-black text-sm">{streak} dias</span>
                        </div>
                    </div>

                    <div className="bg-white dark:bg-zinc-900 p-4 rounded-2xl border border-slate-200 dark:border-zinc-800 shadow-sm overflow-hidden">
                        <div ref={scrollRef} className="flex gap-1 overflow-x-auto no-scrollbar pb-2">
                            <div className="flex gap-1 flex-col flex-wrap h-32 content-start">
                                {heatmapData.map((day, i) => (
                                    <div 
                                        key={day.date} 
                                        className={`w-3 h-3 rounded-sm ${
                                            day.count === 0 ? 'bg-slate-100 dark:bg-zinc-800' :
                                            day.count === 1 ? 'bg-emerald-200 dark:bg-emerald-900/40' :
                                            day.count === 2 ? 'bg-emerald-400 dark:bg-emerald-700' :
                                            'bg-emerald-600 dark:bg-emerald-500'
                                        }`}
                                        title={`${formatDate(day.date)}: ${day.count} atividades`}
                                    ></div>
                                ))}
                            </div>
                        </div>
                        <div className="flex justify-between text-[10px] font-bold text-slate-400 mt-2 px-1">
                            <span>Menos</span>
                            <span>Mais</span>
                        </div>
                    </div>

                    <div className="flex items-center justify-between bg-slate-100 dark:bg-zinc-800/50 p-2 rounded-xl">
                        <button onClick={() => changeDate(-1)} className="p-2 hover:bg-white dark:hover:bg-zinc-700 rounded-lg transition-colors"><Icons.ChevronLeft size={20} className="text-slate-500"/></button>
                        <div className="font-bold text-slate-700 dark:text-slate-200">
                            {selectedDate === getTodayStr() ? 'Hoje, ' : ''}{formatFullDate(selectedDate)}
                        </div>
                        <button onClick={() => changeDate(1)} className="p-2 hover:bg-white dark:hover:bg-zinc-700 rounded-lg transition-colors" disabled={selectedDate >= getTodayStr()}><Icons.ChevronRight size={20} className={selectedDate >= getTodayStr() ? "text-slate-300 dark:text-zinc-800" : "text-slate-500"}/></button>
                    </div>

                    <div className="grid grid-cols-1 gap-3">
                        {['Questões', 'Anki', 'Aula'].map(item => {
                            const isDone = status[item === 'Questões' ? 'questions' : item === 'Anki' ? 'anki' : 'class'];
                            const config = {
                                'Questões': { icon: Icons.Target, color: 'blue' },
                                'Anki': { icon: Icons.Layers, color: 'purple' },
                                'Aula': { icon: Icons.MonitorPlay, color: 'red' }
                            }[item];
                            const Icon = config.icon;
                            
                            return (
                                <button 
                                    key={item}
                                    onClick={() => toggleChecklist(item)}
                                    className={`relative p-4 rounded-2xl border-2 transition-all duration-300 flex items-center justify-between group active:scale-[0.98] ${
                                        isDone 
                                        ? `bg-${config.color}-50 dark:bg-${config.color}-900/20 border-${config.color}-500 dark:border-${config.color}-500` 
                                        : 'bg-white dark:bg-zinc-900 border-slate-100 dark:border-zinc-800 hover:border-slate-200 dark:hover:border-zinc-700'
                                    }`}
                                >
                                    <div className="flex items-center gap-4">
                                        <div className={`w-12 h-12 rounded-xl flex items-center justify-center transition-colors ${
                                            isDone ? `bg-${config.color}-500 text-white` : `bg-slate-100 dark:bg-zinc-800 text-slate-400 dark:text-zinc-600`
                                        }`}>
                                            <Icon size={24} strokeWidth={isDone ? 3 : 2} />
                                        </div>
                                        <div className="text-left">
                                            <div className={`text-lg font-bold transition-colors ${isDone ? `text-${config.color}-700 dark:text-${config.color}-300` : 'text-slate-700 dark:text-slate-300'}`}>{item}</div>
                                            <div className="text-xs font-medium text-slate-400 dark:text-slate-500">{isDone ? 'Concluído!' : 'Toque para marcar'}</div>
                                        </div>
                                    </div>
                                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${
                                        isDone ? `bg-${config.color}-500 border-${config.color}-500` : 'border-slate-300 dark:border-zinc-600'
                                    }`}>
                                        {isDone && <Icons.CheckCircle2 size={14} className="text-white" strokeWidth={4} />}
                                    </div>
                                </button>
                            );
                        })}
                    </div>

                    <div className="mt-4">
                        <button onClick={() => setShowUpcoming(true)} className="w-full py-3 bg-slate-800 dark:bg-zinc-800 text-white dark:text-slate-200 font-bold rounded-xl shadow-lg flex items-center justify-center gap-2 hover:bg-slate-700 transition-colors">
                            <Icons.ListTodo size={18} />
                            Ver Próximas Revisões
                        </button>
                    </div>

                    <ModalWrapper isOpen={showUpcoming} onClose={() => setShowUpcoming(false)} title="Próximas Revisões">
                        <div className="p-4 space-y-3">
                            {upcomingReviews.length === 0 ? (
                                <div className="text-center text-slate-400 py-8">
                                    <Icons.CheckCircle2 className="mx-auto mb-2" size={32} />
                                    <p>Tudo em dia! Nenhuma revisão futura agendada.</p>
                                </div>
                            ) : (
                                upcomingReviews.map((item, i) => {
                                    const colorMap = { clinica: 'blue', cirurgia: 'red', pediatria: 'amber', go: 'purple', preventiva: 'emerald' };
                                    const c = colorMap[item.topic.area] || 'blue';
                                    return (
                                        <div key={i} className="flex items-center justify-between p-3 bg-white dark:bg-zinc-900 rounded-xl border border-slate-100 dark:border-zinc-800">
                                            <div className="flex-1">
                                                <div className="text-[10px] font-bold uppercase tracking-wider text-slate-400 mb-0.5">{formatFullDate(item.review.date)}</div>
                                                <div className="font-bold text-slate-800 dark:text-white">{item.topic.title}</div>
                                                <div className={`text-xs font-medium text-${c}-500`}>{item.review.label} • {item.review.targetQ}q</div>
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                        </div>
                    </ModalWrapper>
                </div>
            );
        };

        const CalendarView = ({ topics, onOpenReview }) => {
            const [displayDate, setDisplayDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(null);
            const currentMonth = displayDate.getMonth();
            const currentYear = displayDate.getFullYear();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const startDay = new Date(currentYear, currentMonth, 1).getDay();
            const days = Array(startDay).fill(null).concat([...Array(daysInMonth).keys()].map(i => i + 1));
            const prevMonth = () => setDisplayDate(new Date(currentYear, currentMonth - 1, 1));
            const nextMonth = () => setDisplayDate(new Date(currentYear, currentMonth + 1, 1));
            const goToday = () => setDisplayDate(new Date());
            
            const getReviewsForDate = (dateStr) => { 
                const list = []; 
                topics.forEach(t => { 
                    if (t.deleted) return; 
                    t.reviews.forEach((r, idx) => { 
                        if (r.date === dateStr) list.push({ topic: t, review: r, idx }); 
                    }); 
                }); 
                return list; 
            };

            return (
                <div className="animate-fade-in pb-32">
                    <div className="bg-white dark:bg-zinc-900 rounded-3xl border border-slate-200 dark:border-white/5 shadow-sm p-6">
                        <div className="flex items-center justify-between mb-6"><h3 className="text-xl font-bold text-slate-800 dark:text-white capitalize flex items-center gap-2">{displayDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}</h3><div className="flex gap-1"><button onClick={prevMonth} className="p-2 hover:bg-slate-100 dark:hover:bg-zinc-800 rounded-full"><Icons.ChevronLeft size={20}/></button><button onClick={goToday} className="px-3 py-1 text-xs font-bold bg-slate-100 dark:bg-zinc-800 rounded-lg hover:bg-slate-200 dark:hover:bg-zinc-700">Hoje</button><button onClick={nextMonth} className="p-2 hover:bg-slate-100 dark:hover:bg-zinc-800 rounded-full"><Icons.ChevronRight size={20}/></button></div></div>
                        <div className="grid grid-cols-7 gap-2 mb-2">{['D', 'S', 'T', 'Q', 'Q', 'S', 'S'].map((d, i) => <div key={i} className="text-center text-xs font-bold text-slate-400">{d}</div>)}</div>
                        <div className="grid grid-cols-7 gap-2">{days.map((day, idx) => { if (!day) return <div key={idx} className="aspect-square"></div>; const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; const reviews = getReviewsForDate(dateStr); const isToday = dateStr === getTodayStr(); const pending = reviews.filter(x => !x.review.done).length; const done = reviews.filter(x => x.review.done).length; const hasDots = pending > 0 || done > 0; return (<button key={idx} onClick={() => reviews.length && setSelectedDate(dateStr)} className={`aspect-square rounded-xl flex flex-col items-center justify-center relative transition-all ${isToday ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' : 'bg-slate-50 dark:bg-zinc-950 text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-zinc-800'}`}><span className={`text-sm font-bold`}>{day}</span>{hasDots && (<div className="flex gap-0.5 mt-1 max-w-[80%] flex-wrap justify-center">{[...Array(Math.min(3, pending))].map((_, i) => <div key={`p${i}`} className={`w-1 h-1 rounded-full ${isToday ? 'bg-white/70' : 'bg-blue-500'}`}></div>)}{[...Array(Math.min(3, done))].map((_, i) => <div key={`d${i}`} className={`w-1 h-1 rounded-full ${isToday ? 'bg-emerald-300' : 'bg-emerald-500'}`}></div>)}</div>)}</button>); })}</div>
                        <div className="flex justify-center gap-4 mt-6 text-xs font-bold text-slate-500"><div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-blue-500"></div> A Fazer</div><div className="flex items-center gap-1.5"><div className="w-2 h-2 rounded-full bg-emerald-500"></div> Concluído</div></div>
                    </div>
                    {selectedDate && (
                        <ModalWrapper isOpen={!!selectedDate} onClose={() => setSelectedDate(null)} title={formatFullDate(selectedDate)}>
                            <div className="p-4 space-y-3">
                                {getReviewsForDate(selectedDate).length === 0 ? (
                                    <p className="text-center text-slate-400 py-4">Nada agendado.</p>
                                ) : (
                                    getReviewsForDate(selectedDate).map((item, i) => {
                                        const areaInfo = AREAS.find(a => a.id === item.topic.area) || AREAS[0];
                                        const colorMap = { clinica: 'blue', cirurgia: 'red', pediatria: 'amber', go: 'purple', preventiva: 'emerald' };
                                        const colorName = colorMap[item.topic.area] || 'blue';
                                        
                                        const accuracy = item.review.total > 0 ? Math.round((item.review.correct / item.review.total) * 100) : 0;
                                        
                                        const questionsDisplay = item.review.done 
                                            ? `${item.review.correct}/${item.review.total} acertos`
                                            : (item.review.targetQ > 0 ? `Meta: ${item.review.targetQ}q` : 'Revisão');

                                        return (
                                            <div key={i} className={`p-4 rounded-xl border relative overflow-hidden ${
                                                item.review.done 
                                                ? `bg-white/50 dark:bg-zinc-900/50 border-slate-200 dark:border-zinc-800 opacity-80` 
                                                : `bg-white dark:bg-zinc-900 border-slate-200 dark:border-${colorName}-500/30 shadow-sm`
                                            }`}>
                                                <div className={`absolute left-0 top-0 bottom-0 w-1.5 ${areaInfo.color.split(' ')[0].replace('bg-', 'bg-').replace('/20', '-500')}`}></div>
                                                
                                                <div className="flex justify-between items-start pl-3">
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <span className={`text-[10px] font-bold uppercase tracking-wider px-1.5 py-0.5 rounded ${areaInfo.color}`}>
                                                                {areaInfo.name.toUpperCase()}
                                                            </span>
                                                            {item.topic.importance === 'high' && <span className="text-red-500 text-[10px] flex items-center"><Icons.Star size={10} fill="currentColor"/></span>}
                                                        </div>
                                                        <div className="font-bold text-slate-800 dark:text-white leading-tight mb-1">{item.topic.title}</div>
                                                        <div className="text-xs font-medium text-slate-500 dark:text-slate-400 flex items-center gap-1.5">
                                                            <span className="font-bold bg-slate-100 dark:bg-zinc-800 px-1.5 rounded text-slate-600 dark:text-slate-300">{item.review.label.split(':')[0]}</span>
                                                            <span>{item.review.label.split(':')[1]} • {questionsDisplay}</span>
                                                        </div>
                                                    </div>

                                                    <div className="flex flex-col items-end gap-2">
                                                        {item.review.done ? (
                                                            <>
                                                                <span className={`text-sm font-black ${accuracy >= 80 ? 'text-emerald-500' : 'text-amber-500'}`}>{accuracy}%</span>
                                                                <div className="flex gap-0.5">
                                                                    {[...Array(3)].map((_, dotI) => (
                                                                        <div key={dotI} className={`w-1 h-1 rounded-full ${dotI < Math.ceil(accuracy/33) ? (accuracy >= 80 ? 'bg-emerald-500' : 'bg-amber-500') : 'bg-slate-200 dark:bg-zinc-700'}`}></div>
                                                                    ))}
                                                                </div>
                                                            </>
                                                        ) : (
                                                            <button onClick={() => { setSelectedDate(null); onOpenReview(item.topic.id, item.idx); }} className="text-xs font-bold bg-blue-600 text-white px-3 py-1.5 rounded-lg shadow-blue-500/20 shadow-lg">
                                                                Revisar
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })
                                )}
                            </div>
                        </ModalWrapper>
                    )}
                </div>
            );
        };

        const AddTopicModal = ({ isOpen, onClose, onSave }) => {
            if (!isOpen) return null;
            const [title, setTitle] = useState('');
            const [area, setArea] = useState('clinica');
            const [subarea, setSubarea] = useState('');
            const [importance, setImportance] = useState('medium');
            const [date, setDate] = useState(getTodayStr());
            const [link, setLink] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                if(!title) return;
                vibrate(VIBRATE_PATTERNS.tick);
                onSave({ title, area, subarea, importance, date, link });
                setTitle(''); setSubarea(''); setLink(''); onClose();
            };
            const subAreaOptions = SUB_AREAS[area] || [];
            return (
                 <ModalWrapper isOpen={isOpen} onClose={onClose} title="Novo Conteúdo">
                        <div className="p-6 space-y-5">
                            <div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">O que você estudou?</label><input autoFocus type="text" placeholder="Ex: Insuficiência Cardíaca" className="w-full text-lg font-semibold bg-transparent border-b-2 border-slate-200 dark:border-zinc-700 focus:border-blue-500 outline-none py-2 placeholder-slate-300 dark:placeholder-zinc-600 dark:text-white transition-colors" value={title} onChange={e => setTitle(e.target.value)} /></div>
                            <div className="grid grid-cols-2 gap-4"><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">Área</label><select className="w-full p-3 rounded-xl bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 text-sm font-medium dark:text-slate-200 focus:ring-2 focus:ring-blue-500 outline-none" value={area} onChange={e => { setArea(e.target.value); setSubarea(''); }}>{AREAS.map(a => <option key={a.id} value={a.id}>{a.full}</option>)}</select></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">Subárea</label><select className="w-full p-3 rounded-xl bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 text-sm font-medium dark:text-slate-200 focus:ring-2 focus:ring-blue-500 outline-none" value={subarea} onChange={e => setSubarea(e.target.value)}><option value="">Geral</option>{subAreaOptions.map(s => <option key={s} value={s}>{s}</option>)}</select></div></div>
                            <div className="space-y-3"><label className="block text-xs font-bold text-slate-500 uppercase">Prioridade</label><div className="grid grid-cols-3 gap-3">{IMPORTANCE_LEVELS.map(lvl => (<button key={lvl.id} type="button" onClick={() => { vibrate(VIBRATE_PATTERNS.tick); setImportance(lvl.id); }} className={`py-3 rounded-xl text-sm font-bold border transition-all ${importance === lvl.id ? `border-${lvl.color.split('-')[1]}-500 bg-${lvl.color.split('-')[1]}-50 dark:bg-${lvl.color.split('-')[1]}-900/30 ${lvl.color}` : 'border-slate-200 dark:border-zinc-700 text-slate-400 hover:border-slate-300'}`}>{lvl.label}</button>))}</div></div>
                            <div className="grid grid-cols-1 gap-4"><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">Data</label><input type="date" className="w-full p-3 rounded-xl bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 text-sm dark:text-slate-200 outline-none" value={date} onChange={e => setDate(e.target.value)} /></div><div><label className="block text-xs font-bold text-slate-500 uppercase mb-1.5">Link (Opcional)</label><input type="url" placeholder="https://..." className="w-full p-3 rounded-xl bg-slate-50 dark:bg-zinc-800 border border-slate-200 dark:border-zinc-700 text-sm dark:text-slate-200 outline-none" value={link} onChange={e => setLink(e.target.value)} /></div></div>
                        </div>
                        <div className="p-4 border-t border-slate-100 dark:border-zinc-800 bg-slate-50 dark:bg-zinc-900 rounded-b-2xl"><button onClick={handleSubmit} className="w-full py-3.5 bg-blue-600 hover:bg-blue-700 active:scale-[0.98] transition-all text-white font-bold rounded-xl shadow-lg shadow-blue-500/25 flex items-center justify-center gap-2"><Icons.Plus size={20}/> Criar Plano</button></div>
                 </ModalWrapper>
            );
        };

        // PERFORMANCE OPTIMIZATION: Memorized TopicCard to avoid re-renders
        const TopicCard = React.memo(({ topic, onOpenReview, onDelete }) => {
            const [expanded, setExpanded] = useState(false);
            const areaConfig = AREAS.find(a => a.id === topic.area) || AREAS[0];
            const activeBorder = areaConfig.accent;
            const reviewsDone = topic.reviews.filter(r => r.done);
            const completedCount = reviewsDone.length;
            const avgAccuracy = reviewsDone.length > 0 ? Math.round(reviewsDone.reduce((acc, r) => acc + (r.correct/r.total), 0) / reviewsDone.length * 100) : 0;
            const nextReview = topic.reviews.find(r => !r.done);
            const isLate = nextReview && nextReview.date < getTodayStr();

            const colorMap = {
                clinica: 'blue',
                cirurgia: 'red',
                pediatria: 'amber',
                go: 'purple',
                preventiva: 'emerald'
            };
            const c = colorMap[topic.area] || 'blue';

            // Fixed Touch Logic for Safari to prevent ghost swipes
            const touchStartX = useRef(0);
            const touchEndX = useRef(0);

            const handleTouchStart = (e) => {
                touchStartX.current = e.targetTouches[0].clientX;
                touchEndX.current = e.targetTouches[0].clientX; // Reset end to start
            };

            const handleTouchMove = (e) => {
                touchEndX.current = e.targetTouches[0].clientX;
            };

            const handleTouchEnd = () => {
                if (touchStartX.current - touchEndX.current > 100) {
                    // Swipe Left (Optional: Delete?)
                }
                if (touchEndX.current - touchStartX.current > 100) {
                    // Swipe Right - Trigger next review
                    const nextReviewIndex = topic.reviews.findIndex(r => !r.done);
                    if (nextReviewIndex !== -1) {
                        vibrate(VIBRATE_PATTERNS.tick);
                        onOpenReview(topic.id, nextReviewIndex);
                    }
                }
            };

            return (
                <div 
                    className={`group bg-white dark:bg-zinc-900 rounded-2xl border-l-[6px] ${activeBorder} shadow-sm hover:shadow-xl dark:shadow-black/50 transition-all duration-300 mb-4 overflow-hidden relative border-y border-r border-slate-100 dark:border-${c}-900/50`}
                    onTouchStart={handleTouchStart}
                    onTouchMove={handleTouchMove}
                    onTouchEnd={handleTouchEnd}
                >
                    <div className="p-4 cursor-pointer" onClick={() => setExpanded(!expanded)}>
                        <div className="flex justify-between items-start">
                            <div className="flex-1 pr-4">
                                <div className="flex items-center gap-2 mb-1.5">
                                    <span className="text-[10px] font-bold tracking-wider uppercase text-slate-400 dark:text-slate-500">
                                        {areaConfig.name}{topic.subarea ? ` - ${topic.subarea}` : ''}
                                    </span>
                                    {topic.importance === 'high' && <span className="bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 text-[10px] font-bold px-1.5 py-0.5 rounded flex items-center gap-0.5"><Icons.Star size={10} fill="currentColor"/> Alta</span>}
                                    {isLate && <span className="bg-orange-50 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 text-[10px] font-bold px-1.5 py-0.5 rounded flex items-center gap-0.5"><Icons.Clock size={10}/> Atrasado</span>}
                                </div>
                                <h3 className={`font-bold text-slate-800 dark:text-slate-100 text-lg leading-tight group-hover:text-${c}-600 dark:group-hover:text-${c}-400 transition-colors`}>{topic.title}</h3>
                            </div>
                            <div className="flex flex-col items-end gap-1.5">
                                {completedCount > 0 && ( <span className={`text-xs font-black px-2 py-0.5 rounded-full ${avgAccuracy >= 80 ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-500/20 dark:text-emerald-400' : 'bg-amber-100 text-amber-700 dark:bg-amber-500/20 dark:text-amber-400'}`}>{avgAccuracy}%</span> )}
                                <div className="flex gap-1">{[0,1,2,3].map(i => { const rev = topic.reviews[i]; let color = 'bg-slate-200 dark:bg-zinc-800'; if (rev && rev.done) color = (rev.correct/rev.total) >= 0.8 ? 'bg-emerald-500' : 'bg-amber-500'; else if (rev && !rev.done && (i === 0 || topic.reviews[i-1].done)) color = `bg-${c}-500 animate-pulse`; return <div key={i} className={`w-1.5 h-1.5 rounded-full ${color}`}></div> })}</div>
                            </div>
                        </div>
                    </div>
                    {expanded && (
                        <div className="px-4 pb-4 pt-0 bg-slate-50/50 dark:bg-zinc-950/30 border-t border-slate-100 dark:border-zinc-800 animate-fade-in">
                            <div className="space-y-2 mt-3">{topic.reviews.map((rev, idx) => { const isNext = !rev.done && (idx === 0 || topic.reviews[idx-1].done); const isDone = rev.done; const acc = rev.total > 0 ? Math.round((rev.correct/rev.total)*100) : 0; const isLateItem = !isDone && rev.date < getTodayStr(); return ( <div key={idx} className={`flex items-center justify-between p-2.5 rounded-xl transition-colors ${isNext ? `bg-white dark:bg-zinc-800 shadow-sm border border-${c}-100 dark:border-${c}-900/30` : 'opacity-70'}`}> <div className="flex items-center gap-3"> <div className={`font-black text-xs w-6 ${isDone ? 'text-slate-400' : isNext ? `text-${c}-600 dark:text-${c}-400` : 'text-slate-300'}`}>{rev.label.split(':')[0]}</div> <div className="flex flex-col"> <span className={`text-xs font-medium ${isLateItem ? 'text-orange-600 dark:text-orange-400' : 'text-slate-600 dark:text-slate-300'}`}>{formatDate(rev.date)} {isLateItem && '(Atrasado)'}</span> {rev.targetQ && !isDone && <span className="text-[10px] text-blue-500 font-bold flex items-center gap-1"><Icons.Target size={10}/> Meta: {rev.targetQ}q</span>} </div> </div> {isDone ? ( <div className={`font-bold text-sm ${acc >= 80 ? 'text-emerald-500' : 'text-amber-500'}`}>{acc}%</div> ) : isNext ? ( <button onClick={(e) => {e.stopPropagation(); onOpenReview(topic.id, idx); vibrate(VIBRATE_PATTERNS.tick);}} className={`bg-${c}-600 hover:bg-${c}-700 text-white text-xs font-bold px-3 py-1.5 rounded-lg shadow-md shadow-${c}-500/20 active:scale-95 transition-transform`}>Revisar</button> ) : (<Icons.Lock size={14} className="text-slate-300 dark:text-zinc-700"/>)} </div> ) })}</div>
                            <div className="mt-4 pt-3 border-t border-slate-200 dark:border-zinc-800 flex justify-between items-center">{topic.materialLink ? ( <a href={topic.materialLink} target="_blank" className="text-xs font-bold text-blue-500 hover:underline flex items-center gap-1"><Icons.LinkIcon size={12}/> Material</a> ) : <div></div>} <button onClick={(e) => { e.stopPropagation(); onDelete(topic.id); }} className="text-xs text-slate-400 hover:text-red-500 flex items-center gap-1 transition-colors px-2 py-1 hover:bg-red-50 dark:hover:bg-red-900/20 rounded"><Icons.Trash2 size={12}/> Excluir</button></div>
                        </div>
                    )}
                    <div className="absolute top-5 right-4 pointer-events-none text-slate-300 dark:text-zinc-600">{expanded ? <Icons.ChevronUp size={16}/> : <Icons.ChevronDown size={16}/>}</div>
                </div>
            );
        }, (prev, next) => 
            prev.topic.id === next.topic.id && 
            prev.topic.updatedAt === next.topic.updatedAt
        );

        const AreaDetailView = ({ areaId, onBack, topics }) => {
            const area = AREAS.find(a => a.id === areaId);
            const areaTopics = topics.filter(t => t.area === areaId && !t.deleted);
            
            const stats = useMemo(() => {
                const totalQ = areaTopics.reduce((acc, t) => acc + t.reviews.filter(r => r.done).reduce((s, r) => s + (r.total || 0), 0), 0);
                const totalC = areaTopics.reduce((acc, t) => acc + t.reviews.filter(r => r.done).reduce((s, r) => s + (r.correct || 0), 0), 0);
                const globalAcc = totalQ > 0 ? Math.round((totalC/totalQ)*100) : 0;
                return { totalQ, globalAcc };
            }, [areaTopics]);

            return (
                <div className="animate-slide-in-right pb-32">
                    <div className="flex items-center gap-3 mb-6">
                        <button onClick={onBack} className="p-2 rounded-xl bg-white dark:bg-zinc-900 shadow-sm border border-slate-200 dark:border-white/5 text-slate-600 dark:text-slate-300">
                            <Icons.ArrowLeft size={20}/>
                        </button>
                        <div>
                            <h2 className="text-xl font-bold text-slate-800 dark:text-white">{area.full}</h2>
                            <p className="text-xs text-slate-500">{areaTopics.length} tópicos cadastrados</p>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-6">
                        <div className="bg-white dark:bg-zinc-900 p-4 rounded-2xl border border-slate-200 dark:border-white/5 shadow-sm">
                            <div className="text-xs text-slate-500 uppercase font-bold mb-1">Aproveitamento</div>
                            <div className={`text-3xl font-black ${stats.globalAcc >= 80 ? 'text-emerald-500' : 'text-amber-500'}`}>{stats.globalAcc}%</div>
                        </div>
                        <div className="bg-white dark:bg-zinc-900 p-4 rounded-2xl border border-slate-200 dark:border-white/5 shadow-sm">
                            <div className="text-xs text-slate-500 uppercase font-bold mb-1">Questões</div>
                            <div className="text-3xl font-black text-slate-800 dark:text-white">{stats.totalQ}</div>
                        </div>
                    </div>

                    <div className="space-y-3">
                        {areaTopics.length === 0 ? <div className="text-center text-slate-400 py-10">Nenhum tópico nesta área.</div> : 
                        areaTopics.map(t => {
                            const done = t.reviews.filter(r => r.done);
                            const tAcc = done.length > 0 ? Math.round(done.reduce((a,b)=>a+(b.correct/b.total),0)/done.length*100) : 0;
                            return (
                                <div key={t.id} className="bg-white dark:bg-zinc-900 p-4 rounded-xl border border-slate-200 dark:border-white/5 flex justify-between items-center active:scale-[0.98] transition-transform cursor-pointer">
                                    <div className="flex-1 pr-2 overflow-hidden">
                                        <div className="font-bold text-slate-800 dark:text-slate-200 truncate">{t.title}</div>
                                        <div className="text-xs text-slate-500">{done.length}/4 Revisões</div>
                                    </div>
                                    <div className={`font-bold text-lg ${tAcc >= 80 ? 'text-emerald-500' : tAcc >= 60 ? 'text-amber-500' : 'text-slate-400'}`}>{done.length > 0 ? tAcc + '%' : '-'}</div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            )
        };

        const BentoDashboard = ({ topics, onSelectArea }) => {
            const stats = useMemo(() => {
                const active = topics.filter(t => !t.deleted);
                const reviewsDone = active.reduce((acc, t) => acc + t.reviews.filter(r => r.done).length, 0);
                const totalQ = active.reduce((acc, t) => acc + t.reviews.filter(r => r.done).reduce((s, r) => s + (r.total || 0), 0), 0);
                const totalC = active.reduce((acc, t) => acc + t.reviews.filter(r => r.done).reduce((s, r) => s + (r.correct || 0), 0), 0);
                const globalAcc = totalQ > 0 ? Math.round((totalC/totalQ)*100) : 0;
                const areaStats = AREAS.map(a => { const ts = active.filter(t => t.area === a.id); const q = ts.reduce((ac, t) => ac + t.reviews.filter(r => r.done).reduce((s, r) => s + (r.total || 0), 0), 0); const c = ts.reduce((ac, t) => ac + t.reviews.filter(r => r.done).reduce((s, r) => s + (r.correct || 0), 0), 0); return { ...a, acc: q > 0 ? Math.round((c/q)*100) : 0, q }; }).sort((a,b) => b.acc - a.acc);
                
                const last30Days = [];
                const today = new Date();
                for(let i=29; i>=0; i--) {
                    const d = new Date(today);
                    d.setDate(d.getDate() - i);
                    const dStr = d.toISOString().split('T')[0];
                    let dCorrect = 0;
                    let dTotal = 0;
                    active.forEach(t => {
                        t.reviews.forEach(r => {
                            if(r.done && r.date === dStr) {
                                dCorrect += (r.correct || 0);
                                dTotal += (r.total || 0);
                            }
                        })
                    });
                    last30Days.push(dTotal > 0 ? Math.round((dCorrect/dTotal)*100) : 0);
                }

                return { active: active.length, reviewsDone, totalQ, globalAcc, areaStats, last30Days };
            }, [topics]);

            const Sparkline = ({ data }) => {
                const max = 100;
                const points = data.map((val, i) => `${(i / (data.length - 1)) * 100},${100 - val}`).join(' ');
                return (
                    <svg viewBox="0 0 100 100" className="w-full h-12 opacity-50" preserveAspectRatio="none">
                        <polyline fill="none" stroke="currentColor" strokeWidth="2" points={points} />
                    </svg>
                );
            };

            return (
                <div className="space-y-4 animate-fade-in pb-32">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="col-span-2 md:col-span-2 bg-gradient-to-br from-blue-500 to-blue-600 rounded-3xl p-6 text-white shadow-xl shadow-blue-500/20 relative overflow-hidden">
                            <Icons.Activity className="absolute right-4 top-4 opacity-20" size={80}/>
                            <div className="relative z-10">
                                <div className="text-blue-100 text-sm font-medium mb-1 uppercase tracking-wide">Performance 30 Dias</div>
                                <div className="text-5xl font-black tracking-tight mb-2">{stats.globalAcc}%</div>
                                <div className="h-12 w-full"><Sparkline data={stats.last30Days} /></div>
                                <div className="text-blue-100 text-xs mt-2 font-medium flex justify-between">
                                    <span>{stats.totalQ} questões respondidas</span>
                                    <span className="opacity-80 font-bold">Top 5% 🔥</span>
                                </div>
                            </div>
                        </div>
                        <div className="col-span-1 bg-white dark:bg-zinc-900 rounded-3xl p-5 border border-slate-200 dark:border-white/5 shadow-sm flex flex-col justify-center"><div className="w-10 h-10 rounded-full bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 flex items-center justify-center mb-3"><Icons.CheckCircle2 size={20}/></div><div className="text-2xl font-bold text-slate-800 dark:text-white">{stats.reviewsDone}</div><div className="text-xs text-slate-400 font-medium">Revisões Feitas</div></div>
                        <div className="col-span-1 bg-white dark:bg-zinc-900 rounded-3xl p-5 border border-slate-200 dark:border-white/5 shadow-sm flex flex-col justify-center"><div className="w-10 h-10 rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 flex items-center justify-center mb-3"><Icons.Layers size={20}/></div><div className="text-2xl font-bold text-slate-800 dark:text-white">{stats.active}</div><div className="text-xs text-slate-400 font-medium">Tópicos Ativos</div></div>
                    </div>
                    <div className="bg-white dark:bg-zinc-900 rounded-3xl border border-slate-200 dark:border-white/5 shadow-sm p-6">
                        <h3 className="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2"><Icons.BarChart3 size={20} className="text-slate-400"/> Performance por Área</h3>
                        <div className="space-y-4">
                            {stats.areaStats.map(area => (
                                <div key={area.id} onClick={() => onSelectArea(area.id)} className="relative cursor-pointer group active:scale-[0.99] transition-transform">
                                    <div className="flex justify-between text-xs mb-1.5 font-bold">
                                        <span className="text-slate-600 dark:text-slate-300 group-hover:text-blue-500 transition-colors flex items-center gap-1">{area.name} <Icons.ChevronRight size={12} className="opacity-0 group-hover:opacity-100 transition-opacity"/></span>
                                        <span className={area.acc >= 80 ? 'text-emerald-500' : area.acc >= 60 ? 'text-amber-500' : 'text-slate-400'}>{area.acc}%</span>
                                    </div>
                                    <div className="h-2.5 w-full bg-slate-100 dark:bg-zinc-800 rounded-full overflow-hidden">
                                        <div className={`h-full rounded-full transition-all duration-500 ${area.acc >= 80 ? 'bg-emerald-500' : area.acc >= 60 ? 'bg-amber-500' : 'bg-slate-300 dark:bg-zinc-700'}`} style={{width: `${area.acc}%`}}></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [topics, setTopics] = useState([]);
            const [logs, setLogs] = useState([]);
            const [dataLoaded, setDataLoaded] = useState(false);

            useEffect(() => {
                if (dataLoaded) return;
                try {
                    const t = safeStorage.getJSON('resiflow_v3_data', []);
                    const l = safeStorage.getJSON('resiflow_logs', []);
                    setTopics(t);
                    setLogs(l);
                } catch (e) {
                    console.warn('Erro ao carregar dados locais', e);
                }
                setDataLoaded(true);
            }, [dataLoaded]);

            const [view, setView] = useState('list');
            const [filter, setFilter] = useState('all');
            const [areaFilter, setAreaFilter] = useState('all');
            const [searchTerm, setSearchTerm] = useState('');
            const [darkMode, setDarkMode] = useState(() => safeStorage.getItem('resiflow_theme') === 'dark');
            
            const [modalAddOpen, setModalAddOpen] = useState(false);
            const [reviewModalData, setReviewModalData] = useState(null);
            const [settingsOpen, setSettingsOpen] = useState(false);
            const [pomodoroOpen, setPomodoroOpen] = useState(false);
            const [deleteConfirmId, setDeleteConfirmId] = useState(null);
            const [selectedDashboardArea, setSelectedDashboardArea] = useState(null);

            const { status, syncKey, setSyncKey, saveToCloud } = useSync(topics, logs, setTopics, setLogs);

            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                    safeStorage.setItem('resiflow_theme', 'dark');
                } else {
                    document.documentElement.classList.remove('dark');
                    safeStorage.setItem('resiflow_theme', 'light');
                }
            }, [darkMode]);

            useEffect(() => {
                safeStorage.setItem('resiflow_v3_data', JSON.stringify(topics));
                safeStorage.setItem('resiflow_logs', JSON.stringify(logs));
                if (status === 'online') { const t = setTimeout(() => saveToCloud(topics, logs), 2000); return () => clearTimeout(t); }
            }, [topics, logs, status]);

            const visibleTopics = useMemo(() => {
                let list = topics.filter(t => !t.deleted);
                
                if(searchTerm) {
                    const lowerTerm = searchTerm.toLowerCase();
                    list = list.filter(t => {
                        const areaName = (AREAS.find(a => a.id === t.area)?.name || '').toLowerCase();
                        const sub = (t.subarea || '').toLowerCase();
                        const title = t.title.toLowerCase();
                        return title.includes(lowerTerm) || areaName.includes(lowerTerm) || sub.includes(lowerTerm);
                    });
                }

                if(filter === 'today') list = list.filter(t => t.reviews.some(r => !r.done && r.date <= getTodayStr()));
                if(areaFilter !== 'all') list = list.filter(t => t.area === areaFilter);
                
                list.sort((a,b) => { const nextA = a.reviews.find(r => !r.done)?.date || '9999'; const nextB = b.reviews.find(r => !r.done)?.date || '9999'; return nextA.localeCompare(nextB); });
                return list;
            }, [topics, searchTerm, filter, areaFilter]);

            const handleAddTopic = (data) => {
                const schedule = generateSchedule(data.date, data.importance);
                const newTopic = { id: generateId(), title: data.title, area: data.area, subarea: data.subarea, importance: data.importance, materialLink: data.link, studyDate: data.date, reviews: schedule, deleted: false, updatedAt: Date.now() };
                setTopics([newTopic, ...topics]);
            };

            const triggerDelete = (id) => { setDeleteConfirmId(id); };

            const handleOpenReview = useCallback((topicId, reviewIdx) => {
                setTopics(currentTopics => {
                    const topic = currentTopics.find(t => t.id === topicId);
                    if (topic) {
                        const review = topic.reviews[reviewIdx];
                        setReviewModalData({
                            topicId,
                            reviewIdx,
                            title: topic.title,
                            label: review.label,
                            target: review.targetQ
                        });
                    }
                    return currentTopics; 
                });
            }, []);

            const handleDelete = useCallback((id) => {
                setDeleteConfirmId(id);
            }, []);

            const confirmDelete = () => {
                if (deleteConfirmId) {
                    vibrate(VIBRATE_PATTERNS.tick);
                    setTopics(prev => prev.map(t => t.id === deleteConfirmId ? {...t, deleted: true, updatedAt: Date.now()} : t));
                    setDeleteConfirmId(null);
                }
            };

            const handleAddLog = (log) => setLogs([log, ...logs]);
            const handleDeleteLog = (id) => setLogs(prev => prev.map(l => l.id === id ? { ...l, deleted: true, updatedAt: Date.now() } : l));

            const handleReviewSave = (data) => {
                if(!reviewModalData) return;
                vibrate(VIBRATE_PATTERNS.reviewDone);
                const { topicId, reviewIdx } = reviewModalData;
                setTopics(prev => prev.map(t => {
                    if(t.id !== topicId) return t;
                    const newRevs = [...t.reviews];
                    newRevs[reviewIdx] = { ...newRevs[reviewIdx], done: true, correct: data.correct, total: data.total };
                    
                    if(reviewIdx + 1 < newRevs.length) {
                        const acc = data.total > 0 ? data.correct/data.total : 0;
                        const nextLoad = calculateNextLoad(t.importance, data.difficulty, newRevs[reviewIdx+1].type, acc);
                        newRevs[reviewIdx+1].targetQ = nextLoad;
                        
                        const nextDate = newRevs[reviewIdx+1].date;
                        const existingNotifs = safeStorage.getJSON('resiflow_notifications', []);
                        existingNotifs.push({ date: nextDate, title: t.title, type: newRevs[reviewIdx+1].label });
                        safeStorage.setItem('resiflow_notifications', JSON.stringify(existingNotifs));
                    }
                    return { ...t, reviews: newRevs, updatedAt: Date.now() }; 
                }));
                setReviewModalData(null);
            };

            useEffect(() => {
                if (Notification.permission === 'granted') {
                    const today = getTodayStr();
                    const notifs = safeStorage.getJSON('resiflow_notifications', []);
                    const todayNotifs = notifs.filter(n => n.date === today);
                    
                    if(todayNotifs.length > 0) {
                        const lastNotified = safeStorage.getItem('resiflow_last_notif_date');
                        if(lastNotified !== today) {
                            new Notification(`ResiFlow: ${todayNotifs.length} revisões hoje!`, {
                                body: `Mantenha o foco! Você tem ${todayNotifs.length} tópicos para revisar.`,
                                icon: 'icon.svg'
                            });
                            safeStorage.setItem('resiflow_last_notif_date', today);
                        }
                    }
                }
            }, []);

            if (!dataLoaded) {
                 return (
                    <div className="fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-slate-50 dark:bg-zinc-950 transition-opacity duration-300">
                        <div className="loader-icon">
                             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
                        </div>
                    </div>
                 );
            }

            return (
                <div className="min-h-screen pb-32 md:pb-10 relative overflow-x-hidden pt-safe">
                    <div className="fixed inset-0 w-full h-full overflow-hidden -z-10 pointer-events-none bg-slate-50 dark:bg-zinc-950 transition-colors duration-300">
                         <div className="absolute top-0 left-0 -translate-x-1/4 -translate-y-1/4 w-[80vw] h-[80vw] max-w-[800px] max-h-[800px] bg-blue-400/10 dark:bg-blue-600/10 rounded-full blur-[100px] mix-blend-multiply dark:mix-blend-screen opacity-70 dark:opacity-15"></div>
                         <div className="absolute bottom-0 right-0 translate-x-1/4 translate-y-1/4 w-[80vw] h-[80vw] max-w-[800px] max-h-[800px] bg-purple-400/10 dark:bg-indigo-900/10 rounded-full blur-[100px] mix-blend-multiply dark:mix-blend-screen opacity-70 dark:opacity-15"></div>
                    </div>

                    <header className="fixed top-0 w-full z-40 glass border-b border-slate-200/50 dark:border-white/5 transition-all pt-safe">
                        <div className="max-w-3xl mx-auto px-4 h-16 flex items-center justify-between">
                            <h1 className="text-xl font-bold flex items-center gap-2 tracking-tight text-slate-800 dark:text-white">
                                <div className="w-8 h-8 rounded-xl bg-gradient-to-br from-blue-500 to-indigo-600 flex items-center justify-center text-white shadow-lg shadow-blue-500/20"><Icons.Activity size={18}/></div> ResiFlow
                            </h1>
                            <div className="flex items-center gap-1">
                                <button onClick={() => { vibrate(VIBRATE_PATTERNS.tick); setPomodoroOpen(true); }} className="p-2.5 rounded-full hover:bg-slate-100 dark:hover:bg-zinc-800 text-slate-500"><Icons.Timer size={20}/></button>
                                <button onClick={() => { vibrate(VIBRATE_PATTERNS.tick); setSettingsOpen(true); }} className={`p-2.5 rounded-full hover:bg-slate-100 dark:hover:bg-zinc-800 transition-colors ${status === 'online' ? 'text-blue-500' : 'text-slate-500'}`}><Icons.Settings size={20}/></button>
                                <button onClick={() => { vibrate(VIBRATE_PATTERNS.tick); setDarkMode(!darkMode); }} className="p-2.5 rounded-full hover:bg-slate-100 dark:hover:bg-zinc-800 text-slate-500 transition-colors">{darkMode ? <Icons.Sun size={20}/> : <Icons.Moon size={20}/>}</button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-3xl mx-auto px-4 mt-24">
                        <nav className="md:hidden fixed bottom-0 left-0 w-full glass border-t border-slate-200/50 dark:border-white/5 z-50 flex justify-around items-center py-4 px-4 pb-safe">
                            {[{id:'list',i:Icons.Home},{id:'calendar',i:Icons.Calendar},{id:'dashboard',i:Icons.PieChart},{id:'diary',i:Icons.Notebook}].map(item => (
                                <button key={item.id} onClick={() => { vibrate(VIBRATE_PATTERNS.tick); setView(item.id); setSelectedDashboardArea(null); }} className={`flex flex-col items-center gap-1 p-3 rounded-2xl transition-all active:scale-95 ${view === item.id ? 'text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20' : 'text-slate-400 hover:text-slate-600 dark:hover:text-slate-200'}`}>
                                    <item.i size={24} strokeWidth={view === item.id ? 2.5 : 2}/>
                                </button>
                            ))}
                        </nav>

                        <div className="fixed bottom-24 left-1/2 -translate-x-1/2 md:translate-x-0 md:bottom-6 md:static md:mb-6 z-[55] mb-safe">
                             <button onClick={() => { vibrate(VIBRATE_PATTERNS.tick); setModalAddOpen(true); }} className="w-14 h-14 md:w-full md:h-12 md:rounded-xl rounded-full bg-blue-600 hover:bg-blue-700 text-white shadow-xl shadow-blue-600/30 flex items-center justify-center gap-2 transition-transform hover:scale-105 active:scale-95"><Icons.Plus size={24}/><span className="hidden md:inline font-bold">Novo Tópico</span></button>
                        </div>

                        <div className="hidden md:flex gap-2 mb-6 p-1 bg-slate-100 dark:bg-zinc-900/50 rounded-xl w-fit backdrop-blur-sm">
                            {[{id:'list',l:'Lista',i:Icons.List},{id:'calendar',l:'Calendário',i:Icons.Calendar},{id:'diary',l:'Diário',i:Icons.Notebook},{id:'dashboard',l:'Análise',i:Icons.PieChart}].map(tab => (
                                <button key={tab.id} onClick={() => { setView(tab.id); setSelectedDashboardArea(null); }} className={`px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${view === tab.id ? 'bg-white dark:bg-zinc-800 text-slate-800 dark:text-white shadow-sm' : 'text-slate-500 hover:text-slate-700 dark:hover:text-slate-300'}`}><tab.i size={16}/> {tab.l}</button>
                            ))}
                        </div>

                        <div className="animate-fade-in">
                            {view === 'dashboard' ? ( 
                                selectedDashboardArea ? 
                                <AreaDetailView areaId={selectedDashboardArea} onBack={() => setSelectedDashboardArea(null)} topics={topics} /> : 
                                <BentoDashboard topics={topics} onSelectArea={setSelectedDashboardArea} /> 
                            ) : 
                             view === 'calendar' ? ( <CalendarView topics={topics} onOpenReview={(tid, idx) => { const t=topics.find(x=>x.id===tid); setReviewModalData({topicId:tid,reviewIdx:idx,title:t.title,label:t.reviews[idx].label,target:t.reviews[idx].targetQ}) }} /> ) : 
                             view === 'diary' ? ( <DiaryView logs={logs} onAddLog={handleAddLog} onDeleteLog={handleDeleteLog} topics={topics} /> ) : (
                                <>
                                    <div className="flex flex-col gap-3 mb-4">
                                        <div className="flex flex-col sm:flex-row gap-3">
                                            <div className="relative flex-1"><Icons.Search className="absolute left-3 top-3 text-slate-400" size={18}/><input type="text" placeholder="Buscar assunto..." className="w-full pl-10 pr-4 py-2.5 rounded-xl bg-white dark:bg-zinc-900 border border-slate-200 dark:border-white/5 text-sm focus:ring-2 focus:ring-blue-500 outline-none dark:text-white" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} /></div>
                                            <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                                                <button onClick={() => { vibrate(VIBRATE_PATTERNS.tick); setFilter(filter === 'today' ? 'all' : 'today'); }} className={`px-4 py-2.5 rounded-xl text-sm font-bold border transition-colors whitespace-nowrap ${filter === 'today' ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-600 border-blue-200' : 'bg-white dark:bg-zinc-900 text-slate-600 dark:text-slate-400 border-slate-200 dark:border-white/5'}`}>{filter === 'today' ? '📅 Hoje' : '📅 Todos'}</button>
                                                <button onClick={() => setAreaFilter('all')} className={`px-3 py-2.5 rounded-lg text-xs font-bold whitespace-nowrap border transition-all ${areaFilter === 'all' ? 'bg-slate-800 text-white dark:bg-white dark:text-black border-transparent' : 'bg-white dark:bg-zinc-900 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-white/5'}`}>Todos</button>
                                                {AREAS.map(a => (
                                                    <button key={a.id} onClick={() => setAreaFilter(a.id)} className={`px-3 py-2.5 rounded-lg text-xs font-bold whitespace-nowrap border transition-all ${areaFilter === a.id ? `${a.color} border-transparent` : 'bg-white dark:bg-zinc-900 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-white/5'}`}>{a.name}</button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    {visibleTopics.length === 0 ? (
                                        <div className="flex flex-col items-center justify-center py-20 text-center opacity-60"><div className="w-20 h-20 bg-slate-100 dark:bg-zinc-900 rounded-full flex items-center justify-center mb-4 text-slate-300 dark:text-zinc-700"><Icons.BookOpen size={32}/></div><h3 className="font-bold text-slate-700 dark:text-slate-300">Nada por aqui</h3><p className="text-sm text-slate-500">Adicione um novo tópico para começar.</p></div>
                                    ) : (
                                        visibleTopics.map(t => ( 
                                            <TopicCard 
                                                key={t.id} 
                                                topic={t} 
                                                onOpenReview={handleOpenReview} 
                                                onDelete={handleDelete} 
                                            /> 
                                        ))
                                    )}
                                </>
                            )}
                        </div>
                    </main>

                    <AddTopicModal isOpen={modalAddOpen} onClose={() => setModalAddOpen(false)} onSave={handleAddTopic} />
                    <SettingsModal isOpen={settingsOpen} onClose={() => setSettingsOpen(false)} topics={topics} logs={logs} setTopics={setTopics} setLogs={setLogs} syncKey={syncKey} setSyncKey={setSyncKey} status={status} />
                    <PomodoroTimer isOpen={pomodoroOpen} onClose={() => setPomodoroOpen(false)} />
                    
                    {deleteConfirmId && (
                        <ModalWrapper isOpen={!!deleteConfirmId} onClose={() => setDeleteConfirmId(null)} title="Confirmar Exclusão">
                            <div className="p-6">
                                <div className="flex flex-col items-center text-center mb-6">
                                    <div className="w-16 h-16 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center text-red-500 mb-4"><Icons.AlertTriangle size={32}/></div>
                                    <h4 className="font-bold text-lg text-slate-800 dark:text-white">Tem certeza?</h4>
                                    <p className="text-sm text-slate-500 mt-2">Você está prestes a excluir este tópico e todo o seu histórico de revisões.</p>
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => setDeleteConfirmId(null)} className="flex-1 py-3 bg-slate-100 dark:bg-zinc-800 text-slate-600 dark:text-slate-300 font-bold rounded-xl">Cancelar</button>
                                    <button onClick={confirmDelete} className="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white font-bold rounded-xl shadow-lg shadow-red-500/30">Sim, Excluir</button>
                                </div>
                            </div>
                        </ModalWrapper>
                    )}

                    {reviewModalData && (
                        <ModalWrapper isOpen={!!reviewModalData} onClose={() => setReviewModalData(null)} title={reviewModalData.title}>
                                <div className="p-6">
                                <div className="text-xs text-slate-500 uppercase font-bold mb-4">{reviewModalData.label}</div>
                                <form onSubmit={(e) => { e.preventDefault(); const fd = new FormData(e.target); handleReviewSave({ correct: +fd.get('c'), total: +fd.get('t'), difficulty: fd.get('d') }); }} className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-xs font-bold text-slate-400">Acertos</label><input autoFocus name="c" type="number" className="w-full text-center text-2xl font-bold py-3 bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 rounded-xl outline-none border border-transparent focus:border-emerald-500" required/></div>
                                        <div><label className="text-xs font-bold text-slate-400">Total</label><input name="t" type="number" className="w-full text-center text-2xl font-bold py-3 bg-slate-50 dark:bg-zinc-800 text-slate-600 dark:text-white rounded-xl outline-none border border-transparent focus:border-blue-500" required defaultValue={reviewModalData.target}/></div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-400 block mb-2">Dificuldade</label>
                                        <div className="grid grid-cols-3 gap-2">
                                            <label className="cursor-pointer"><input type="radio" name="d" value="easy" className="peer hidden"/><div className="py-2 text-center rounded-lg border border-slate-200 dark:border-zinc-700 text-sm font-bold text-slate-500 peer-checked:bg-emerald-500 peer-checked:text-white peer-checked:border-emerald-500">Fácil</div></label>
                                            <label className="cursor-pointer"><input type="radio" name="d" value="medium" className="peer hidden" defaultChecked/><div className="py-2 text-center rounded-lg border border-slate-200 dark:border-zinc-700 text-sm font-bold text-slate-500 peer-checked:bg-amber-500 peer-checked:text-white peer-checked:border-amber-500">Médio</div></label>
                                            <label className="cursor-pointer"><input type="radio" name="d" value="hard" className="peer hidden"/><div className="py-2 text-center rounded-lg border border-slate-200 dark:border-zinc-700 text-sm font-bold text-slate-500 peer-checked:bg-red-500 peer-checked:text-white peer-checked:border-red-500">Difícil</div></label>
                                        </div>
                                    </div>
                                    <button className="w-full py-3 bg-slate-900 dark:bg-white dark:text-black text-white font-bold rounded-xl mt-2">Concluir Revisão</button>
                                </form>
                                </div>
                        </ModalWrapper>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
